name: ðŸ“¦ Publish AgentMem to PyPI

on:
  push:
    tags:
      - 'agentmem-v*.*.*'  # Matches: agentmem-v0.1.0, agentmem-v0.1.1, etc.

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: ðŸ” Extract version from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/agentmem-v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Publishing AgentMem version: $TAG"
      
      - name: âœ… Verify version matches pyproject.toml
        run: |
          cd agentmem
          PYPROJECT_VERSION=$(python -c "import tomli; print(tomli.load(open('pyproject.toml', 'rb'))['project']['version'])" 2>/dev/null || grep -oP '(?<=version = ")[^"]+' pyproject.toml)
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          
          echo "ðŸ“¦ Package version: $PYPROJECT_VERSION"
          echo "ðŸ·ï¸  Tag version: $TAG_VERSION"
          
          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo ""
            echo "âŒ ERROR: Version mismatch!"
            echo "   Tag: agentmem-v$TAG_VERSION"
            echo "   pyproject.toml: $PYPROJECT_VERSION"
            echo ""
            echo "Fix: Update agentmem/pyproject.toml version to $TAG_VERSION"
            exit 1
          fi
          
          echo "âœ… Version matches!"
      
      - name: ðŸ—ï¸ Build package
        run: |
          cd agentmem
          python -m build
          echo "ðŸ“¦ Built packages:"
          ls -lh dist/
      
      - name: ðŸš€ Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd agentmem
          python -m twine upload dist/* --verbose
      
      - name: ðŸŽ‰ Success message
        run: |
          echo "âœ… AgentMem v${{ steps.get_version.outputs.version }} published to PyPI!"
          echo "ðŸ“¦ Install with: pip install agentmem==${{ steps.get_version.outputs.version }}"
          echo "ðŸ”— View on PyPI: https://pypi.org/project/agentmem/${{ steps.get_version.outputs.version }}/"

