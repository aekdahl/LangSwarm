name: ğŸ“¦ Publish AgentMem to PyPI

on:
  push:
    tags:
      - 'agentmem-v*.*.*'  # Matches: agentmem-v0.1.0, agentmem-v0.1.1, etc.

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: ğŸ” Extract version from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/agentmem-v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Publishing AgentMem version: $TAG"
      
      - name: âœ… Verify version matches pyproject.toml
        run: |
          cd agentmem
          # Extract version from pyproject.toml (PEP 621 format)
          PYPROJECT_VERSION=$(grep -m 1 '^version = ' pyproject.toml | cut -d'"' -f2)
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          
          echo "ğŸ“¦ Package version: $PYPROJECT_VERSION"
          echo "ğŸ·ï¸  Tag version: $TAG_VERSION"
          
          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo ""
            echo "âŒ ERROR: Version mismatch!"
            echo "   Tag: agentmem-v$TAG_VERSION"
            echo "   pyproject.toml: $PYPROJECT_VERSION"
            echo ""
            echo "Fix: Update agentmem/pyproject.toml version to $TAG_VERSION"
            exit 1
          fi
          
          echo "âœ… Version matches!"
      
      - name: ğŸ—ï¸ Build package
        run: |
          cd agentmem
          python -m build
          echo "ğŸ“¦ Built packages:"
          ls -lh dist/
      
      - name: ğŸš€ Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd agentmem
          python -m twine upload dist/* --verbose
      
      - name: ğŸ‰ Success message
        run: |
          echo "âœ… AgentMem v${{ steps.get_version.outputs.version }} published to PyPI!"
          echo "ğŸ“¦ Install with: pip install agentmem==${{ steps.get_version.outputs.version }}"
          echo "ğŸ”— View on PyPI: https://pypi.org/project/agentmem/${{ steps.get_version.outputs.version }}/"

