name: üì¶ Publish LangSwarm-Memory to PyPI

on:
  push:
    tags:
      - 'langswarm-memory-v*.*.*'  # Matches: langswarm-memory-v0.1.0, langswarm-memory-v0.1.1, etc.

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: üì¶ Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: üîç Extract version from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/langswarm-memory-v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "üìå Publishing LangSwarm-Memory version: $TAG"
      
      - name: ‚úÖ Verify version matches pyproject.toml
        run: |
          cd langswarm-memory
          # Extract version from pyproject.toml (PEP 621 format)
          PYPROJECT_VERSION=$(grep -m 1 '^version = ' pyproject.toml | cut -d'"' -f2)
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          
          echo "üì¶ Package version: $PYPROJECT_VERSION"
          echo "üè∑Ô∏è  Tag version: $TAG_VERSION"
          
          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo ""
            echo "‚ùå ERROR: Version mismatch!"
            echo "   Tag: langswarm-memory-v$TAG_VERSION"
            echo "   pyproject.toml: $PYPROJECT_VERSION"
            echo ""
            echo "Fix: Update langswarm-memory/pyproject.toml version to $TAG_VERSION"
            exit 1
          fi
          
          echo "‚úÖ Version matches!"
      
      - name: üèóÔ∏è Build package
        run: |
          cd langswarm-memory
          python -m build
          echo "üì¶ Built packages:"
          ls -lh dist/
      
      - name: üöÄ Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd langswarm-memory
          python -m twine upload dist/* --verbose
      
      - name: üéâ Success message
        run: |
          echo "‚úÖ LangSwarm-Memory v${{ steps.get_version.outputs.version }} published to PyPI!"
          echo "üì¶ Install with: pip install langswarm-memory==${{ steps.get_version.outputs.version }}"
          echo "üîó View on PyPI: https://pypi.org/project/langswarm-memory/${{ steps.get_version.outputs.version }}/"

