name: ğŸ Publish LangSwarm to PyPI

on:
  push:
    tags:
      - 'langswarm-v*.*.*'  # Matches: langswarm-v0.0.54.dev46, langswarm-v0.1.0, etc.

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: ğŸ” Extract version from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/langswarm-v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Publishing LangSwarm version: $TAG"
      
      - name: âœ… Verify version matches pyproject.toml
        run: |
          PYPROJECT_VERSION=$(poetry version -s)
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          
          echo "ğŸ“¦ Package version: $PYPROJECT_VERSION"
          echo "ğŸ·ï¸  Tag version: $TAG_VERSION"
          
          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo ""
            echo "âŒ ERROR: Version mismatch!"
            echo "   Tag: langswarm-v$TAG_VERSION"
            echo "   pyproject.toml: $PYPROJECT_VERSION"
            echo ""
            echo "Fix: Run 'poetry version $TAG_VERSION' and commit"
            exit 1
          fi
          
          echo "âœ… Version matches!"
      
      - name: ğŸ” Verify langswarm-memory dependency
        run: |
          MEMORY_DEP=$(grep -A1 'langswarm-memory' pyproject.toml | grep -v 'path' | grep -v '#' || echo "")
          
          if grep -q 'path.*langswarm-memory' pyproject.toml; then
            echo "âŒ ERROR: langswarm-memory uses local path dependency!"
            echo ""
            echo "Current:"
            grep -A1 'langswarm-memory' pyproject.toml
            echo ""
            echo "Fix: Change to: langswarm-memory = \"^0.1.0\""
            exit 1
          fi
          
          echo "âœ… langswarm-memory dependency is correct (not using local path)"
      
      - name: ğŸ—ï¸ Build package
        run: |
          poetry build
          echo "ğŸ“¦ Built packages:"
          ls -lh dist/
      
      - name: ğŸ”§ Configure PyPI credentials
        run: |
          poetry config pypi-token.pypi ${{ secrets.PYPI_API_TOKEN }}
      
      - name: ğŸš€ Publish to PyPI
        run: |
          poetry publish --no-interaction --verbose
      
      - name: ğŸ‰ Success message
        run: |
          echo "âœ… LangSwarm v${{ steps.get_version.outputs.version }} published to PyPI!"
          echo "ğŸ“¦ Install with: pip install langswarm==${{ steps.get_version.outputs.version }}"
          echo "ğŸ”— View on PyPI: https://pypi.org/project/langswarm/${{ steps.get_version.outputs.version }}/"

